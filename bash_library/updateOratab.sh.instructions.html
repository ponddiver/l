<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <meta
    name="description"
    content="Comprehensive documentation for updateOratab.sh script including development history, global variables, functions, testing checklist, and deployment guidance."
  />
  <meta name="color-scheme" content="light dark" />
  <meta property="og:title" content="updateOratab.sh - Script Creation Instructions" />
  <meta
    property="og:description"
    content="Monitor Oracle databases and automatically update /etc/oratab file with running instances."
  />
  <meta property="og:type" content="website" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <title>updateOratab.sh - Script Creation Instructions</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="header-container">
      <h1>updateOratab.sh - Script Creation Instructions</h1>
    </div>
  </header>

  <main>
    <nav class="toc">
      <h3>Table of Contents</h3>
      <ul>
        <li><a href="#metadata">Metadata</a></li>
        <li><a href="#initial-request">Initial Request</a></li>
        <li><a href="#purpose">Script Purpose</a></li>
        <li><a href="#core-requirements">Core Requirements</a></li>
        <li><a href="#development-history">Development History</a></li>
        <li><a href="#global-variables">Global Variables</a></li>
        <li><a href="#execution-model">Execution Model</a></li>
        <li><a href="#key-functions">Key Functions</a></li>
        <li><a href="#cli">Command-Line Interface</a></li>
        <li><a href="#design-decisions">Design Decisions</a></li>
        <li><a href="#testing">Testing Checklist</a></li>
        <li><a href="#deployment">Deployment Notes</a></li>
        <li><a href="#version-history">Version History</a></li>
        <li><a href="#future-enhancements">Future Enhancements</a></li>
        <li><a href="#maintainers">Notes for Maintainers</a></li>
        <li><a href="#related-scripts">Related Scripts</a></li>
        <li><a href="#dependencies">Dependencies</a></li>
        <li><a href="#best-practices">Best Practices</a></li>
      </ul>
    </nav>

    <article class="container">
      <section class="metadata" id="metadata">
        <h2>Metadata</h2>
        <p><strong>Script Name:</strong> updateOratab.sh</p>
        <p><strong>Created:</strong> December 21, 2025</p>
        <p><strong>Version:</strong> 1.0 Stable</p>
        <p><strong>Purpose:</strong> Monitor Oracle databases and automatically update /etc/oratab file with running instances</p>
      </section>

      <section class="section" id="initial-request">
        <h2>Initial Request</h2>
        <p>Create a bash script that monitors Oracle databases and automatically updates the /etc/oratab file to ensure it reflects currently running instances, with support for continuous monitoring and scheduled execution via systemd timers.</p>
        
      </section>

      <section class="section" id="purpose">
        <h2>Script Purpose</h2>
        <p>Monitor Oracle database instances on a system and maintain an accurate /etc/oratab file that reflects which databases are currently running. The script automatically detects running instances via process monitoring, creates backups of /etc/oratab before modifications, and optionally removes entries for databases no longer running. It supports three operational modes: continuous background monitoring, single update pass, and systemd timer-based scheduled updates.</p>
        
      </section>

      <section class="section" id="core-requirements">
        <h2>Core Requirements (Initial)</h2>
        <ul>
          <li>Monitor when Oracle databases update the /etc/oratab file</li>
          <li>Ensure only one script occurrence runs at a time (locking)</li>
          <li>Support continuous monitoring mode with configurable interval</li>
          <li>Support single update mode (execute once and exit)</li>
          <li>Support systemd timer installation for scheduled updates</li>
          <li>Create backups of /etc/oratab before modifications</li>
          <li>Maintain backup retention (configurable days, default 3)</li>
          <li>Clean up non-running database entries from /etc/oratab</li>
          <li>Execute as oracle user (no unnecessary privilege escalation)</li>
          <li>Provide verbose debug output option</li>
          <li>Support dry-run mode for testing changes</li>
          <li>Use PID-based locking mechanism for concurrency control</li>
        </ul>
        
      </section>

      <section class="section" id="development-history">
        <h2>Development History</h2>

        <div class="phase">
          <h3>Phase 1: Initial Script Creation with Core Functionality</h3>
          <ul>
            <li>Created comprehensive Oracle database monitoring script</li>
            <li>Implemented process discovery via ora_pmon_SIDNAME detection</li>
            <li>Added exclusive locking mechanism (PID-based)</li>
            <li>Added support for three operational modes (monitor, update-once, install-timer)</li>
            <li>Implemented /etc/oratab file update logic</li>
            <li>Added backup creation before modifications</li>
            <li>Implemented systemd timer support</li>
            <li>Added verbose and dry-run modes</li>
            <li>Integrated with loggy.sh for structured logging</li>
          </ul>
        </div>

        <div class="phase">
          <h3>Phase 2: Global Variable Naming Standardization</h3>
          <p><strong>Instruction:</strong> "change name GV_LOCK_FILE to one that is more specific"</p>
          <p><strong>Changes Made:</strong></p>
          <ul>
            <li>Renamed GV_LOCK_FILE to GV_ORATAB_LOCK_FILE</li>
            <li>Updated all references throughout script (15+ occurrences)</li>
            <li>Applied GV_ORATAB_ prefix to all global variables for consistency</li>
            <li>Documentation updated to reflect new naming scheme</li>
            <li>Naming pattern follows sh.instruction.md guidelines</li>
          </ul>
        </div>

        <div class="phase">
          <h3>Phase 3: Documentation Enhancements</h3>
          <ul>
            <li>Updated script header documentation with examples</li>
            <li>Updated Requirements section with privilege details</li>
            <li>Modified Examples to show proper execution context</li>
            <li>Created comprehensive inline code comments</li>
            <li>Updated help text for all parameters</li>
          </ul>
        </div>

        <div class="phase">
          <h3>Phase 4: Systemd Timer Installation Support</h3>
          <p><strong>Instruction:</strong> "add systemd timer option"</p>
          <p><strong>Changes Made:</strong></p>
          <ul>
            <li>Created _generateServiceFile() function for systemd service unit</li>
            <li>Created _generateTimerFile() function for systemd timer unit</li>
            <li>Added --install-timer flag for installation</li>
            <li>Added --timer-interval parameter (default 60 seconds)</li>
            <li>Added --remove-timer flag for uninstallation</li>
            <li>Implemented _installTimer() function with service generation and systemctl commands</li>
            <li>Implemented _removeTimer() function for cleanup</li>
            <li>Added sudo wrapping for systemd operations</li>
          </ul>
        </div>

        <div class="phase">
          <h3>Phase 5: Execution Model Refinement</h3>
          <p><strong>Instruction:</strong> "assume script executed as user oracle, modify to use sudo where different permissions needed"</p>
          <p><strong>Changes Made:</strong></p>
          <ul>
            <li>Documented execution as oracle user</li>
            <li>Removed sudo from /etc/oratab file operations</li>
            <li>Removed sudo from backup file operations</li>
            <li>Kept sudo for systemd operations (--install-timer, --remove-timer)</li>
            <li>Updated Requirements section to show which operations need sudo</li>
            <li>Updated Examples to show execution without unnecessary sudo</li>
            <li>Created clear privilege model documentation</li>
          </ul>
        </div>

        <div class="phase">
          <h3>Phase 6: Backup Retention and Non-Running Cleanup</h3>
          <p><strong>Instructions:</strong></p>
          <ul>
            <li>"maintain file backups for specific number of days with default value of 3"</li>
            <li>"include cleaning oratab file of databases that are no longer running"</li>
          </ul>
          <p><strong>Changes Made:</strong></p>
          <ul>
            <li>Added GV_ORATAB_BACKUP_RETENTION_DAYS (default: 3 days)</li>
            <li>Created _cleanupOldBackups() function for automated cleanup</li>
            <li>Added --cleanup-nonrunning flag</li>
            <li>Created _cleanupNonRunningEntries() function</li>
            <li>Integrated cleanup into main update flow</li>
          </ul>
        </div>

        
      </section>

      <section class="section" id="global-variables">
        <h2>Global Variable Specifications</h2>
        <p>All variables follow sh.instruction.md naming conventions with GV_ORATAB_ prefix to ensure specificity and prevent conflicts with other scripts:</p>

        <div class="variable-def">
          <strong>GV_ORATAB_MONITOR_MODE</strong><br />
          <em>Default:</em> false | <em>Set by:</em> --monitor flag<br />
          <em>Purpose:</em> Run in continuous loop with interval checks
        </div>

        <div class="variable-def">
          <strong>GV_ORATAB_CHECK_INTERVAL</strong><br />
          <em>Default:</em> 60 | <em>Set by:</em> --interval parameter<br />
          <em>Purpose:</em> Control polling frequency in monitor mode
        </div>

        <div class="variable-def">
          <strong>GV_ORATAB_UPDATE_ONCE</strong><br />
          <em>Default:</em> false | <em>Set by:</em> --update-once flag<br />
          <em>Purpose:</em> Execute one update and exit
        </div>

        <div class="variable-def">
          <strong>GV_ORATAB_TIMER_INTERVAL</strong><br />
          <em>Default:</em> 60 | <em>Set by:</em> --timer-interval parameter<br />
          <em>Purpose:</em> Control schedule frequency for systemd timer
        </div>

        <div class="variable-def">
          <strong>GV_ORATAB_BACKUP_RETENTION_DAYS</strong><br />
          <em>Default:</em> 3 | <em>Set by:</em> Configuration or parameter<br />
          <em>Purpose:</em> Automatic backup cleanup threshold
        </div>

        
      </section>

      <section class="section" id="execution-model">
        <h2>Execution Model</h2>
        <ul>
          <li><strong>Primary execution:</strong> oracle user (database owner)</li>
          <li><strong>Privilege escalation:</strong> Selective sudo only for systemd operations</li>
          <li><strong>Lock mechanism:</strong> PID-based exclusive locking in /tmp</li>
          <li><strong>Lock cleanup:</strong> Automatic stale lock detection (process not running)</li>
          <li><strong>File operations:</strong> No sudo needed (oracle user owns /etc/oratab)</li>
          <li><strong>Systemd operations:</strong> Requires sudo (system service management)</li>
          <li><strong>Background execution:</strong> Suitable for cron jobs and systemd timers</li>
        </ul>
        
      </section>

      <section class="section" id="key-functions">
        <h2>Key Functions</h2>

        <div class="function">
          <h4>_acquireLock()</h4>
          <p>Acquires exclusive lock using PID-based mechanism. Stores current process PID in lock file, checks for stale locks (process no longer running), and cleans up stale locks automatically.</p>
          <p><strong>Returns:</strong> 0 if lock acquired, 1 if already locked<br />
          <strong>Purpose:</strong> Prevent concurrent script execution</p>
        </div>

        <div class="function">
          <h4>_updateOratab()</h4>
          <p>Main update logic for /etc/oratab file. Creates backup, reads current entries, detects running instances, updates entry status, and adds new instances.</p>
          <p><strong>Returns:</strong> 0 on success, 1 on error<br />
          <strong>Purpose:</strong> Core file update functionality</p>
        </div>

        <div class="function">
          <h4>_cleanupOldBackups()</h4>
          <p>Removes backup files beyond retention period. Searches for timestamp-suffixed backups, compares modification time to current time, and deletes files older than configured retention.</p>
          <p><strong>Purpose:</strong> Prevent backup directory from growing indefinitely</p>
        </div>

        <div class="function">
          <h4>_cleanupNonRunningEntries()</h4>
          <p>Removes entries for databases no longer running. Reads current /etc/oratab, checks if ora_pmon_SIDNAME process is running, removes entries not found, and creates backup before modification.</p>
          <p><strong>Purpose:</strong> Keep /etc/oratab synchronized with running instances</p>
        </div>

        
      </section>

      <section class="section" id="cli">
        <h2>Command-Line Interface</h2>

        <h3>Flags/Parameters</h3>
        <ul>
          <li><code>--monitor</code> : Continuous monitoring mode (runs indefinitely)</li>
          <li><code>--interval N</code> : Check interval in seconds (default: 60)</li>
          <li><code>--update-once</code> : Single update pass and exit</li>
          <li><code>--install-timer</code> : Install systemd timer for scheduled updates</li>
          <li><code>--timer-interval N</code> : Timer interval in seconds (default: 60)</li>
          <li><code>--remove-timer</code> : Remove systemd timer</li>
          <li><code>--cleanup-nonrunning</code> : Remove entries for non-running databases</li>
          <li><code>--verbose</code> : Enable verbose debug output</li>
          <li><code>--dry-run</code> : Preview changes without modifying files</li>
          <li><code>--help</code> : Display help message</li>
        </ul>

        <h3>Execution Modes</h3>
        <ol>
          <li><strong>Single update:</strong> <code>./updateOratab.sh --update-once</code></li>
          <li><strong>Continuous monitoring:</strong> <code>./updateOratab.sh --monitor --interval 30 --verbose</code></li>
          <li><strong>Install systemd timer:</strong> <code>sudo ./updateOratab.sh --install-timer --timer-interval 120</code></li>
          <li><strong>Clean up non-running entries:</strong> <code>./updateOratab.sh --update-once --cleanup-nonrunning</code></li>
          <li><strong>Test changes (dry-run):</strong> <code>./updateOratab.sh --update-once --dry-run --verbose</code></li>
          <li><strong>Remove systemd timer:</strong> <code>sudo ./updateOratab.sh --remove-timer</code></li>
        </ol>

        
      </section>

      <section class="section" id="design-decisions">
        <h2>Design Decisions &amp; Rationale</h2>

        <div class="note">
          <h4>1. PID-Based Locking Mechanism</h4>
          <p>Ensures only one script instance modifies /etc/oratab. Prevents corruption from concurrent modifications. PID in lock file enables automatic stale lock detection, better than file existence check.</p>
        </div>

        <div class="note">
          <h4>2. Execution as oracle User</h4>
          <p>Database owner (oracle user) has necessary permissions for /etc/oratab access with minimal privilege elevation. Reduces security risk of unnecessary sudo.</p>
        </div>

        <div class="note">
          <h4>3. Selective sudo Usage</h4>
          <p>File operations don't need sudo; systemd operations do. Keeps privilege escalation minimal with clear separation.</p>
        </div>

        <div class="note">
          <h4>4. Three Operation Modes</h4>
          <p>Continuous monitoring for always-on tracking, single update for cron jobs, systemd timer for modern systems. Provides flexible deployment options.</p>
        </div>

        
      </section>

      <section class="section" id="testing">
        <h2>Testing Checklist</h2>
        <ul>
          <li><input type="checkbox" class="checkbox" /> Test --help parameter displays documentation</li>
          <li><input type="checkbox" class="checkbox" /> Test --update-once executes single update</li>
          <li><input type="checkbox" class="checkbox" /> Test --monitor mode runs continuous loop</li>
          <li><input type="checkbox" class="checkbox" /> Test --interval parameter controls check frequency</li>
          <li><input type="checkbox" class="checkbox" /> Test --install-timer creates systemd files</li>
          <li><input type="checkbox" class="checkbox" /> Test backup creation before modifications</li>
          <li><input type="checkbox" class="checkbox" /> Test backup retention cleanup (>3 days deleted)</li>
          <li><input type="checkbox" class="checkbox" /> Test lock mechanism (second instance waits/fails)</li>
          <li><input type="checkbox" class="checkbox" /> Test with running Oracle instances</li>
          <li><input type="checkbox" class="checkbox" /> Test with no running instances</li>
        </ul>

        
      </section>

      <section class="section" id="deployment">
        <h2>Deployment Notes</h2>

        <h3>Prerequisites</h3>
        <ul>
          <li>Execute as: oracle user (database owner)</li>
          <li>Requires: bash shell (version 4+)</li>
          <li>Requires: ps, grep, awk, sed, tput commands</li>
          <li>Requires: /etc/oratab file (Oracle standard)</li>
          <li>Optional: loggy.sh for enhanced logging</li>
        </ul>

        <h3>Installation</h3>
        <ol>
          <li>Copy updateOratab.sh to appropriate location</li>
          <li>Make executable: <code>chmod +x updateOratab.sh</code></li>
          <li>For systemd timer: <code>sudo ./updateOratab.sh --install-timer</code></li>
        </ol>

        <h3>Usage Example</h3>
        <div class="code-block-wrapper">
          <pre><code>#!/bin/bash
# Cron job for periodic checks (oracle user's crontab)
*/5 * * * * /path/to/updateOratab.sh --update-once

# Systemd timer installation
sudo /path/to/updateOratab.sh --install-timer --timer-interval 300</code></pre>
          <button class="copy-btn" type="button">Copy</button>
        </div>

        
      </section>

      <section class="section" id="version-history">
        <h2>Version History</h2>
        <div class="success">
          <h3>v1.0 (2025-12-21) - Initial Release</h3>
          <ul>
            <li>Complete Oracle database monitoring implementation</li>
            <li>PID-based locking mechanism</li>
            <li>Three operation modes (monitor, update-once, install-timer)</li>
            <li>Systemd timer support</li>
            <li>Backup retention with automatic cleanup</li>
            <li>Non-running entry cleanup functionality</li>
            <li>loggy.sh integration</li>
          </ul>
        </div>

        
      </section>

      <section class="section" id="future-enhancements">
        <h2>Future Enhancement Opportunities</h2>
        <ol>
          <li>CDB/PDB Type Detection: Detect and track PDB instances within CDB</li>
          <li>Email Notifications: Send email alerts when new instances detected</li>
          <li>Metrics Export: Export instance count to monitoring system</li>
          <li>Database Version Detection: Discover and log Oracle version</li>
          <li>Advanced Backup Management: Compression and remote backup copy</li>
          <li>Performance Metrics: Log execution time and track changes</li>
          <li>Configuration File Support: Read defaults from /etc/updateOratab.conf</li>
          <li>Webhook Integration: Send JSON payload to webhook on changes</li>
          <li>Database Connection Check: Verify instance connectivity</li>
          <li>Custom Hooks: Execute user-defined scripts on changes</li>
        </ol>

        
      </section>

      <section class="section" id="maintainers">
        <h2>Notes for Maintainers</h2>

        <h3>Code Organization</h3>
        <ol>
          <li>Sourcing dependencies (loggy.sh, constants.sh)</li>
          <li>Global variable initialization</li>
          <li>Main function dispatching to modes</li>
          <li>Subfunction definitions</li>
        </ol>

        <h3>Common Issues &amp; Solutions</h3>
        <p><strong>Issue:</strong> Lock file prevents execution<br />
        <strong>Solution:</strong> Manually remove /tmp/updateOratab.lock</p>

        <p><strong>Issue:</strong> Permissions denied on /etc/oratab<br />
        <strong>Solution:</strong> Verify oracle user ownership: <code>ls -la /etc/oratab</code></p>

        
      </section>

      <section class="section" id="related-scripts">
        <h2>Related Scripts</h2>
        <ul>
          <li><strong>relocateRacOneNode.sh:</strong> Uses /etc/oratab for instance discovery</li>
          <li><strong>findOracleDatabases.sh:</strong> Alternative discovery method via ps</li>
          <li><strong>sqlToJson.sh:</strong> Can query database for instance info</li>
        </ul>

        
      </section>

      <section class="section" id="dependencies">
        <h2>Dependencies</h2>

        <h3>Required</h3>
        <ul>
          <li>bash shell (4.0+)</li>
          <li>ps, grep, awk, sed, tput commands</li>
        </ul>

        <h3>Optional</h3>
        <ul>
          <li>loggy.sh (graceful fallback if missing)</li>
          <li>constants.sh (graceful fallback if missing)</li>
          <li>systemd (for timer functionality)</li>
        </ul>

        
      </section>

      <section class="section" id="best-practices">
        <h2>Best Practices for Users</h2>

        <h3>1. Schedule Regular Updates</h3>
        <div class="code-block-wrapper">
          <pre><code>sudo ./updateOratab.sh --install-timer --timer-interval 300
# Runs every 5 minutes automatically</code></pre>
          <button class="copy-btn" type="button">Copy</button>
        </div>

        <h3>2. Clean Up Non-Running Entries</h3>
        <div class="code-block-wrapper">
          <pre><code>./updateOratab.sh --update-once --cleanup-nonrunning</code></pre>
          <button class="copy-btn" type="button">Copy</button>
        </div>

        <h3>3. Test Before Deployment</h3>
        <div class="code-block-wrapper">
          <pre><code>./updateOratab.sh --update-once --dry-run --verbose</code></pre>
          <button class="copy-btn" type="button">Copy</button>
        </div>

        
      </section>
    </article>
  </main>

  <footer>
    <p><strong>updateOratab.sh Script Instructions</strong> | Generated: December 21, 2025 | Version 1.0</p>
  </footer>

  <script>
    function scrollToH1() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    const backToTopBtn = document.getElementById('backToTopBtn');
    if (backToTopBtn) {
      backToTopBtn.addEventListener('click', function(e) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }
    document.querySelectorAll('.copy-btn').forEach((button) => {
      button.addEventListener('click', function () {
        const codeBlock = this.previousElementSibling;
        const text = codeBlock.textContent;

        navigator.clipboard.writeText(text).then(() => {
          const originalText = this.textContent;
          this.textContent = 'Copied!';
          this.classList.add('copied');

          setTimeout(() => {
            this.textContent = originalText;
            this.classList.remove('copied');
          }, 2000);
        });
      });
    });

    document.querySelectorAll('a[href^="#"]').forEach((link) => {
      link.addEventListener('click', function (e) {
        const href = this.getAttribute('href');
        if (href !== '#') {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
            window.history.pushState(null, null, href);
          }
        }
      });
    });
  </script>
</body>
</html>

